<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>使用powerdns搭建自己安全的域名解析服务 - 后花园</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="windyboy" /><meta name="description" content="概况 解析服务需要提供两个独立的IP，一主(master)一从(slave)提供解析服务 两个NS服务器IP地址要注册到域名注册商的服务里，解决" /><meta name="keywords" content="Hugo, tech, geek, server" />






<meta name="generator" content="Hugo 0.54.0 with even 4.0.0" />


<link rel="canonical" href="https://windyboy.github.io/post/2017/10/setup-powerdns-authoritative-with-dnssec/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link href="/dist/even.c2a46f00.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="使用powerdns搭建自己安全的域名解析服务" />
<meta property="og:description" content="概况 解析服务需要提供两个独立的IP，一主(master)一从(slave)提供解析服务 两个NS服务器IP地址要注册到域名注册商的服务里，解决" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://windyboy.github.io/post/2017/10/setup-powerdns-authoritative-with-dnssec/" />
<meta property="article:published_time" content="2019-02-14T10:00:00&#43;08:00"/>
<meta property="article:modified_time" content="2019-02-14T10:00:00&#43;08:00"/>

<meta itemprop="name" content="使用powerdns搭建自己安全的域名解析服务">
<meta itemprop="description" content="概况 解析服务需要提供两个独立的IP，一主(master)一从(slave)提供解析服务 两个NS服务器IP地址要注册到域名注册商的服务里，解决">


<meta itemprop="datePublished" content="2019-02-14T10:00:00&#43;08:00" />
<meta itemprop="dateModified" content="2019-02-14T10:00:00&#43;08:00" />
<meta itemprop="wordCount" content="2143">



<meta itemprop="keywords" content="dns,dnssec,powerdns,postgresql,authoritative,cloudxns,powerdns-admin,master,slave,dnssec," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="使用powerdns搭建自己安全的域名解析服务"/>
<meta name="twitter:description" content="概况 解析服务需要提供两个独立的IP，一主(master)一从(slave)提供解析服务 两个NS服务器IP地址要注册到域名注册商的服务里，解决"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">后花园</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">首页</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">分类</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">后花园</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">首页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">分类</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">使用powerdns搭建自己安全的域名解析服务</h1>

      <div class="post-meta">
        <span class="post-time"> 2019-02-14 </span>
        <div class="post-category">
            <a href="/categories/%E6%8A%80%E6%9C%AF/"> 技术 </a>
            </div>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#概况">概况</a></li>
<li><a href="#安装软件">安装软件</a>
<ul>
<li><a href="#从官方的-repo-https-repo-powerdns-com-安装authoritative服务软件">从官方的<a href="https://repo.powerdns.com/">repo</a>安装authoritative服务软件</a></li>
<li><a href="#安装数据库">安装数据库</a></li>
<li><a href="#安装-powerdns-admin">安装 <a href="https://github.com/ngoduykhanh/PowerDNS-Admin" title="web">Powerdns-Admin</a></a></li>
</ul></li>
<li><a href="#配置服务">配置服务</a>
<ul>
<li><a href="#配置环境">配置环境</a></li>
<li><a href="#master-ns1-some-host">Master ns1.some.host</a></li>
<li><a href="#slave-ns2-some-host">Slave ns2.some.host</a></li>
<li><a href="#使用-powerdns-admin-界面创建域名">使用<a href="https://github.com/ngoduykhanh/PowerDNS-Admin" title="web">powerdns-admin</a>界面创建域名</a></li>
<li><a href="#创建dnssec记录">创建DNSSEC记录</a></li>
</ul></li>
<li><a href="#注册解析服务">注册解析服务</a></li>
<li><a href="#检验">检验</a></li>
<li><a href="#参考资料">参考资料</a></li>
<li><a href="#vps-推荐">VPS 推荐</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      

<h2 id="概况">概况</h2>

<ul>
<li>解析服务需要提供两个独立的IP，一主(master)一从(slave)提供解析服务</li>
<li>两个NS服务器IP地址要注册到域名注册商的服务里，解决先有鸡还是先有蛋的问题</li>
<li>DNSSEC的key也要注册到注册商</li>
<li>安装 <a href="https://github.com/ngoduykhanh/PowerDNS-Admin" title="web">powerdns-admin</a> 管理域名</li>
</ul>

<h2 id="安装软件">安装软件</h2>

<p><strong>两台服务器都安装相同的软件, authoritative 和 database</strong></p>

<h3 id="从官方的-repo-https-repo-powerdns-com-安装authoritative服务软件">从官方的<a href="https://repo.powerdns.com/">repo</a>安装authoritative服务软件</h3>

<ul>
<li>创建pdns的源</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></pre></td>
<td class="lntd">
<pre class="chroma"># vim /etc/apt/sources.list.d/pdns.list

deb [arch=amd64] http://repo.powerdns.com/debian stretch-rec-41 main</pre></td></tr></table>
</div>
</div>
<ul>
<li>屏蔽debian自带的pdns</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></pre></td>
<td class="lntd">
<pre class="chroma"># vim /etc/apt/preferences.d/pdns 
Package: pdns-*
Pin: origin repo.powerdns.com
Pin-Priority: 800</pre></td></tr></table>
</div>
</div>
<ul>
<li>引入官方的key</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma"># curl https://repo.powerdns.com/FD380FBB-pub.asc | apt-key add - </pre></td></tr></table>
</div>
</div>
<ul>
<li>安装服务器软件</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span></pre></td>
<td class="lntd">
<pre class="chroma"># apt-get update
# apt-get install pdns-server</pre></td></tr></table>
</div>
</div>
<p><strong><em>其他的系统可以到 <a href="https://repo.powerdns.com/">https://repo.powerdns.com/</a> 参考响应的安装指引</em></strong></p>

<h3 id="安装数据库">安装数据库</h3>

<ul>
<li>安装postgresql</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma"># apt install postgresql postgresql-client</pre></td></tr></table>
</div>
</div>
<ul>
<li>初始化数据库账号</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></pre></td>
<td class="lntd">
<pre class="chroma"># sudo -u postgres psql
postgres=# create user pdns with password &#39;mypdnspassword&#39;;
postgres=# create database pdns owner pdns;
postgres=# grant all privileges on database pdns to pdns;
postgres=# \q</pre></td></tr></table>
</div>
</div>
<ul>
<li>安装powerdns的backend, 创建数据库</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></pre></td>
<td class="lntd">
<pre class="chroma"># apt install pdns-backend-pgsql
# psql -U pdns -d pdns -h 127.0.0.1 -p 5432
pdns=&gt; \i /usr/share/doc/pdns-backend-pgsql/schema.pgsql.sql</pre></td></tr></table>
</div>
</div>
<ul>
<li>建立主从数据的复制</li>
</ul>

<p>在从(Slave)服务器上执行</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></pre></td>
<td class="lntd">
<pre class="chroma"># psql -U pdns -d pdns -h 127.0.0.1 -p 5432

pdns=&gt; insert into supermasters (ip, nameserver, account) values (&#39;x.x.x.x1&#39;, &#39;ns2.some.host&#39;,&#39;admin&#39;);
pdns=&gt; insert into domains (name, master, type) values (&#39;some.host&#39;, &#39;x.x.x.x1&#39;, &#39;SLAVE&#39;);
pdns=&gt;\q

# systemctl restart pdns</pre></td></tr></table>
</div>
</div>
<p>x.x.x.x1 是主服务器的IP地址</p>

<h3 id="安装-powerdns-admin">安装 <a href="https://github.com/ngoduykhanh/PowerDNS-Admin" title="web">Powerdns-Admin</a></h3>

<p><strong>管理界面只安装在主服务器上</strong></p>

<ul>
<li>安装基础设施</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></pre></td>
<td class="lntd">
<pre class="chroma"># apt install -y libmysqlclient-dev libsasl2-dev libldap2-dev libssl-dev libxml2-dev libxslt1-dev libxmlsec1-dev libffi-dev pkg-config apt-transport-https virtualenv build-essential
# curl -sL https://deb.nodesource.com/setup_10.x | bash -
# apt-get install -y nodejs
# curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add -
# echo &#34;deb https://dl.yarnpkg.com/debian/ stable main&#34; | tee /etc/apt/sources.list.d/yarn.list
# apt update -y
# apt install -y yarn
# apt install nginx</pre></td></tr></table>
</div>
</div>
<ul>
<li>创建数据库</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></pre></td>
<td class="lntd">
<pre class="chroma">$ sudo su - postgres
$ createuser powerdnsadmin
$ createdb powerdnsadmindb
$ psql
postgres=# alter user powerdnsadmin with encrypted password &#39;powerdnsadmin&#39;;
postgres=# grant all privileges on database powerdnsadmindb to powerdnsadmin;</pre></td></tr></table>
</div>
</div>
<ul>
<li>安装软件</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></pre></td>
<td class="lntd">
<pre class="chroma"># git clone https://github.com/ngoduykhanh/PowerDNS-Admin.git /opt/web/powerdns-admin
# cd /opt/web/powerdns-admin
# virtualenv -p python3 flask
# source ./flask/bin/activate
# pip install -r requirements.txt
# pip install psycopg2
# cp config_template.py config.py</pre></td></tr></table>
</div>
</div>
<ul>
<li>数据库配置</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span></pre></td>
<td class="lntd">
<pre class="chroma"># vi config.py
SQLALCHEMY_DATABASE_URI = &#39;postgresql://powerdnsadmin:powerdnsadmin@127.0.0.1/powerdnsadmindb&#39;</pre></td></tr></table>
</div>
</div>
<ul>
<li>运行</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></pre></td>
<td class="lntd">
<pre class="chroma"># export FLASK_APP=app/__init__.py
# flask db upgrade
# yarn install --pure-lockfile
# flask assets build
# ./run.py</pre></td></tr></table>
</div>
</div>
<ul>
<li>安装服务</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></pre></td>
<td class="lntd">
<pre class="chroma"># groupadd powerdnsadmin
# useradd --system --user-group powerdnsadmin
# vim /etc/systemd/system/powerdns-admin.service

[Unit]
Description=PowerDNS-Admin
After=network.target

[Service]
Type=simple
User=powerdnsadmin
Group=powerdnsadmin
ExecStart=/opt/web/powerdns-admin/flask/bin/gunicorn --workers 2 --bind unix:/opt/web/powerdns-admin/powerdns-admin.sock app:app
WorkingDirectory=/opt/web/powerdns-admin
Restart=always

[Install]
WantedBy=multi-user.target

# systemctl daemon-reload
# systemctl start powerdns-admin
# systemctl enable powerdns-admin</pre></td></tr></table>
</div>
</div>
<ul>
<li>配置反向代理</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></pre></td>
<td class="lntd">
<pre class="chroma"># vim /etc/nginx/sites-available/pdns

server {
    server_name pdns.some.local ;
    listen 80;
      index                     index.html index.htm index.php;
  root                      /opt/web/powerdns-admin;
  access_log                /var/log/nginx/powerdns-admin.local.access.log combined;
  error_log                 /var/log/nginx/powerdns-admin.local.error.log;

  client_max_body_size              10m;
  client_body_buffer_size           128k;
  proxy_redirect                    off;
  proxy_connect_timeout             90;
  proxy_send_timeout                90;
  proxy_read_timeout                90;
  proxy_buffers                     32 4k;
  proxy_buffer_size                 8k;
  proxy_set_header                  Host $host;
  proxy_set_header                  X-Real-IP $remote_addr;
  proxy_set_header                  X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_headers_hash_bucket_size    64;

  location ~ ^/static/  {
    include  /etc/nginx/mime.types;
    root /opt/web/powerdns-admin/app;

    location ~*  \.(jpg|jpeg|png|gif)$ {
      expires 365d;
    }

    location ~* ^.+.(css|js)$ {
      expires 7d;
    }
  }

  location / {
    proxy_pass            http://unix:/opt/web/powerdns-admin/powerdns-admin.sock;
    proxy_read_timeout    120;
    proxy_connect_timeout 120;
    proxy_redirect        off;
  }
}

# ln -s /etc/nginx/sites-available/pdns /etc/nginx/sites-enabled/pdns
# nginx -t
# systemctl restart nginx</pre></td></tr></table>
</div>
</div>
<ul>
<li>连接到PowerDNS API</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></pre></td>
<td class="lntd">
<pre class="chroma">打开网页 pdns.some.host ， 注册新用户并登陆

打开 API 设置页面，连接到主服务器
http://pdns.some.host/admin/setting/pdns

PDNS API URL: http://localhost:8081
PDNS API KEY: somekey</pre></td></tr></table>
</div>
</div>
<h2 id="配置服务">配置服务</h2>

<h3 id="配置环境">配置环境</h3>

<ul>
<li><p>配置host文件，强制解析 ns1, ns2</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></pre></td>
<td class="lntd">
<pre class="chroma"># vim /etc/hosts
x.x.x.x1   ns1.some.host
x.x.x.x2   ns2.some.host</pre></td></tr></table>
</div>
</div>
<p>两台解析服务器都使用相同配置</p></li>

<li><p>分别在两台主机验证</p></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span></pre></td>
<td class="lntd">
<pre class="chroma"># ping ns1.some.host
# ping ns2.some.host</pre></td></tr></table>
</div>
</div>
<h3 id="master-ns1-some-host">Master ns1.some.host</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></pre></td>
<td class="lntd">
<pre class="chroma"># vim /etc/powerdns/pdns.conf

config-dir=/etc/powerdns
setuid=pdns
setgid=pdns
master=yes
slave=no
allow-axfr-ips=x.x.x.x2/32
default-soa-name=ns1.some.host
dnsupdate=yes
daemon=yes
disable-axfr=no
guardian=yes
local-address=0.0.0.0
local-port=53
log-dns-details=no
log-dns-queries=no
loglevel=9
socket-dir=/var/run
version-string=powerdns
# only 4.0
webserver=yes
api=yes
api-key=somekey
include-dir=/etc/powerdns/pdns.d
launch=</pre></td></tr></table>
</div>
</div>
<p>其中x.x.x.x2为从服务器ns2.some.host的ip地址</p>

<h3 id="slave-ns2-some-host">Slave ns2.some.host</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></pre></td>
<td class="lntd">
<pre class="chroma"># vim /etc/powerdns/pdns.conf

config-dir=/etc/powerdns
setuid=pdns
setgid=pdns
master=no
slave=yes
daemon=yes
disable-axfr=yes
guardian=yes
local-address=0.0.0.0
local-port=53
log-dns-details=no
log-dns-queries=no
loglevel=9
slave-cycle-interval=60
socket-dir=/var/run
version-string=powerdns
include-dir=/etc/powerdns/pdns.d
launch=</pre></td></tr></table>
</div>
</div>
<h3 id="使用-powerdns-admin-界面创建域名">使用<a href="https://github.com/ngoduykhanh/PowerDNS-Admin" title="web">powerdns-admin</a>界面创建域名</h3>

<p>登录到<a href="https://github.com/ngoduykhanh/PowerDNS-Admin" title="web">powerdns-admin</a>的网页， 选择New Domain，进入新建向导的网页, 在 name 里输入域名 some.host, type 设置为 master, SOA-EDIT-API 默认 DEFAULT</p>

<p>点击Dashboard 回到主界面, 从列表中选择刚才创建的域名 some.host</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">some.host   SOA ns1.some.host hostmaster.some.host 2017101100 28800 7200 604800 86400</pre></td></tr></table>
</div>
</div>
<p>第一条ns1.some.host为主服务器域名</p>

<p>第二条hostmaster.some.host实际上是邮件地址，系统替换第一个&rsquo;.&lsquo;为&rsquo;@&lsquo;, 这里代表的地址是hostmaster@some.host，具体可以根据实际情况写自己的邮箱地址</p>

<p>创建成功以后可以用dig命令核实一下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></pre></td>
<td class="lntd">
<pre class="chroma">dig some.host soa @localhost
;; ANSWER SECTION:
some.host.              3600    IN      SOA     ns1.some.host. postmaster.some.host. 2017101106 28800 7200 604800 86400</pre></td></tr></table>
</div>
</div>
<h3 id="创建dnssec记录">创建DNSSEC记录</h3>

<ul>
<li>使用pdnsutil创建DNSSEC</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></pre></td>
<td class="lntd">
<pre class="chroma">pdnsutil secure-zone some.host

Securing zone with default key size
Adding CSK (257) with algorithm ecdsa256
Zone some.host secured
gpgsql Connection successful. Connected to database &#39;pdns&#39; on &#39;localhost&#39;.
Adding NSEC ordering information</pre></td></tr></table>
</div>
</div>
<ul>
<li>查看已经生成的key</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></pre></td>
<td class="lntd">
<pre class="chroma">pdnsutil show-zone some.host

This is a Master zone
Last SOA serial number we notified: 2017101100 == 2017101100 (serial in the database)
Metadata items: None
Zone has NSEC semantics
keys:
ID = 10 (CSK), flags = 257, tag = 59581, algo = 13, bits = 256    Active ( ECDSAP256SHA256 )
CSK DNSKEY = some.host. IN DNSKEY 257 3 13 PQ29wza3majnpUQ+21oEkQjfpyN3dMnTy0StcnNX7YeuRRkOeddqPpFMDoeovZcpQGV0BxduvFn/Q2DW5WXp8w== ; ( ECDSAP256SHA256 )
DS = some.host. IN DS 59581 13 1 7908b7585027f7a262d664c7ee07ae5c5733d44e ; ( SHA1 digest )
DS = some.host. IN DS 59581 13 2 cfc9006e02d2a02448cd8cdde7fcb8e840703883b166685f37db5225ad902a88 ; ( SHA256 digest )
DS = some.host. IN DS 59581 13 3 67099daf0ecaf3e99c1c5dcce132c66dc201d27d2f1baade0fecbbbaa2c6b423 ; ( GOST R 34.11-94 digest )
DS = some.host. IN DS 59581 13 4 53062fef193fae2564f9f2441cb821ae3b55c92afac5790ae70cb8e9359313e0a4c879a09c44c9cb98ed68100cf2e938 ; ( SHA-384 digest )</pre></td></tr></table>
</div>
</div>
<ul>
<li>把相关信息推送到从服务器</li>
</ul>

<p>在主服务器上执行</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma"># pdnsutil rectify-zone some.host</pre></td></tr></table>
</div>
</div>
<h2 id="注册解析服务">注册解析服务</h2>

<ul>
<li>注册nameserver的IP地址</li>
</ul>

<p>打开域名注册商的网页，我这里以<a href="https://www.namesilo.com" title="namesilo">namesilo</a>为例</p>

<p>点击domain manager, 再点击已经注册成功的域名(some.host)，进入域名管理界面</p>

<p>在NameServers部分，点击View/Manage Registered NameServers， 进入注册域名解析服务器页面</p>

<p>点击 REGISTER NEW NAMESERVER 按钮，分别加入ns1, ns2的IP地址</p>

<ul>
<li>注册DNSSEC</li>
</ul>

<p>回到之前域名管理的页面， 点击DS Records (DNSSEC):后面的Update连接</p>

<p>进入注册Key的界面， 相关信息在之前 pdnsutil show-zone some.host 的部分已经列出</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">DS = some.host. IN DS 59581 13 1 7908b7585027f7a262d664c7ee07ae5c5733d44e ; ( SHA1 digest )</pre></td></tr></table>
</div>
</div>
<p>Digest = 7908b7585027f7a262d664c7ee07ae5c5733d44e</p>

<p>Key Tag = 59581</p>

<p>Digest Type = 1</p>

<p>Algorithm = 13</p>

<h2 id="检验">检验</h2>

<ul>
<li>检查域名是否已在全球生效</li>
</ul>

<p>打开网站： <a href="https://dnschecker.org/">https://dnschecker.org/</a></p>

<p>输入域名 some.host , 检查各地的解析情况</p>

<ul>
<li>使用dig在本地服务器检验DNSSEC</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></pre></td>
<td class="lntd">
<pre class="chroma"># dig some.host +dnssec +multi @localhost

;; AUTHORITY SECTION:
some.host.              86400 IN SOA ns1.some.host. hostmaster.some.host. (
                                2017101100 ; serial
                                28800      ; refresh (8 hours)
                                7200       ; retry (2 hours)
                                604800     ; expire (1 week)
                                86400      ; minimum (1 day)
                                )
some.host.              86400 IN RRSIG SOA 13 2 86400 (
                                20171019000000 20170928000000 59581 some.host.
                                UyrOyITKMWhtf2n8lN3ZhtxaAGSMFQI9Qndd49D2/Pe5
                                wWLileK3RVPFRGlXflQfFDfQ6wb7R5+aBCls6qkmIA== )
some.host.              86400 IN NSEC some.host. SOA RRSIG NSEC DNSKEY
some.host.              86400 IN RRSIG NSEC 13 2 86400 (
                                20171019000000 20170928000000 59581 some.host.
                                4fjlTftqvjmoH0OwVf3uuC8OvvuYyyIckn+c5L0J89Np
                                kc1+LCZ5DJpQrnbsWypxr5bDXARB86pr046dbrs21A== )</pre></td></tr></table>
</div>
</div>
<ul>
<li>使用在线工具检验 DNSSEC</li>
</ul>

<p>打开网页 <a href="https://dnssec-debugger.verisignlabs.com">https://dnssec-debugger.verisignlabs.com</a></p>

<p>输入域名 some.host</p>

<h2 id="参考资料">参考资料</h2>

<ul>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-install-and-configure-powerdns-with-a-mariadb-backend-on-ubuntu-14-04">How To Install and Configure PowerDNS with a MariaDB Backend on Ubuntu 14.04</a></li>
<li><a href="https://github.com/ngoduykhanh/PowerDNS-Admin/wiki/Running-PowerDNS-Admin-on-Ubuntu-16.04---Ubuntu-18.04">Running PowerDNS Admin on Ubuntu 16.04 Ubuntu 18.04</a></li>
<li><a href="https://github.com/ngoduykhanh/PowerDNS-Admin/wiki/Using-PowerDNS-Admin-with-PostgreSQL">Using PowerDNS Admin with PostgreSQL</a></li>
<li>官方安装文档 <a href="https://doc.powerdns.com/authoritative/installation.html">https://doc.powerdns.com/authoritative/installation.html</a></li>
</ul>

<h2 id="vps-推荐">VPS 推荐</h2>

<ul>
<li><a href="https://www.linode.com/?r=ec0967c3fb5243693ca573d68000d3a63442ac66">linode 东京</a></li>
<li><a href="https://bandwagonhost.com/aff.php?aff=20451">bandwagonhost 中国优化</a></li>
<li><a href="https://www.cubecloud.net/aff.php?aff=963">cubecloud</a></li>
</ul>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">windyboy</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">2019-02-14</span>
  </p>
  
  
</div><footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/dns/">dns</a>
          <a href="/tags/dnssec/">dnssec</a>
          <a href="/tags/powerdns/">powerdns</a>
          <a href="/tags/postgresql/">postgresql</a>
          <a href="/tags/authoritative/">authoritative</a>
          <a href="/tags/cloudxns/">cloudxns</a>
          <a href="/tags/powerdns-admin/">powerdns-admin</a>
          <a href="/tags/master/">master</a>
          <a href="/tags/slave/">slave</a>
          <a href="/tags/dnssec/">dnssec</a>
          </div>
      <nav class="post-nav">
        
        <a class="next" href="/post/2016/09/tomcat-keystore-using-letsencrypt-certs/">
            <span class="next-text nav-default">tomcat 以 keystore 的方式使用 letsencrypt 证书</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="disqus_thread"></div>
    <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'windyboy';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:windyboy@gmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://twitter.com/windysylph" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://weibo.com/windysylph" class="iconfont icon-weibo" title="weibo"></a>
  <a href="https://windyboy.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2016 - 
    2019
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">windyboy © 2016-2019 版权所有</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-78513355-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
