
<!DOCTYPE html>
<html lang="zh-cn">
<head>

  
  <meta charset="UTF-8">
  <title>
    使用powerdns搭建自己安全的域名解析服务 | 后花园
  </title>


  
  <meta name="viewport" content="width=device-width,user-scalable=no,maximum-scale=1,initial-scale=1">

  
  <link rel="canonical" href="https://windyboy.github.io/post/2017/10/setup-powerdns-authoritative-with-dnssec/"/>

  
  <link rel="stylesheet" href="/css/sanitize.css">
  <link rel="stylesheet" href="/css/responsive.css">
  <link rel="stylesheet" href="/css/highlight_monokai.css">
  <link rel="stylesheet" href="/css/theme.css">
  <link rel="stylesheet" href="/css/custom.css">
  
  
  <link href="https://windyboy.github.io/index.xml" rel="alternate" type="application/rss+xml" title="后花园" />
  <link href="https://windyboy.github.io/index.xml" rel="feed" type="application/rss+xml" title="后花园" />

  
  


</head>



<body>
<div class="container">

  
  <header role="banner">
    <div class="row gutters">
      <div id="site-title" class="col span_6">
        <h1><a href="https://windyboy.github.io/">后花园</a></h1>
        <h2>其他</h2>
      </div>
      <div id="social" class="col span_6">
        <ul>
          <li><a href="https://twitter.com/windysylph" target="_blank">Twitter</a></li>
          
          <li><a href="https://github.com/windyboy" target="_blank">GitHub</a></li>
          <li><a href="https://windyboy.github.io/index.xml" type="application/rss+xml" target="_blank">RSS</a></li>
        </ul>
      </div>
    </div>
  </header>


  
  <main id="single" role="main">
    <div class="article-header">
      <h1>使用powerdns搭建自己安全的域名解析服务</h1>
      <div class="meta">
        Oct 9, 2017 &nbsp;
        
          #<a href="/tags/dns">dns</a>&nbsp;
        
          #<a href="/tags/dnssec">dnssec</a>&nbsp;
        
          #<a href="/tags/powerdns">powerdns</a>&nbsp;
        
          #<a href="/tags/postgresql">postgresql</a>&nbsp;
        
          #<a href="/tags/authoritative">authoritative</a>&nbsp;
        
          #<a href="/tags/cloudxns">cloudxns</a>&nbsp;
        
      </div>
    </div>
    <article>
      

<h2 id="概况">概况</h2>

<ul>
<li>起因： <a href="https://www.cloudxns.net/" title="cloudxns">cloudxns</a>停止了面向个人的服务</li>
<li>解析服务需要提供两个独立的IP，一主一从提供解析服务</li>
<li>两个服务器IP地址要注册到域名注册商的服务里，解决先有鸡还是先有蛋的问题</li>
<li>DNSSEC的key也要注册到注册商</li>
<li>使用<a href="https://www.postgresql.org/" title="postgresql">postgresql</a>替代<a href="https://mariadb.org/" title="mariadb">mariadb</a>原因在于，在目前这个版本中，日志里总是出现连接断开的警告</li>
</ul>

<h2 id="安装软件">安装软件</h2>

<p><strong>两台服务器都安装相同的软件, authoritative 和 database</strong></p>

<h3 id="从官方的-repo-https-repo-powerdns-com-安装authoritative服务软件">从官方的<a href="https://repo.powerdns.com/">repo</a>安装authoritative服务软件</h3>

<ul>
<li>创建pdns的源</li>
</ul>

<pre><code># vim /etc/apt/sources.list.d/pdns.list

deb [arch=amd64] http://repo.powerdns.com/debian stretch-auth-master main
</code></pre>

<ul>
<li>屏蔽debian自带的pdns</li>
</ul>

<pre><code># vim /etc/apt/preferences.d/pdns 
Package: pdns-*
Pin: origin repo.powerdns.com
Pin-Priority: 800
</code></pre>

<ul>
<li>引入官方的key</li>
</ul>

<pre><code># curl https://repo.powerdns.com/FD380FBB-pub.asc | apt-key add - 
</code></pre>

<ul>
<li>安装服务器软件</li>
</ul>

<pre><code># apt-get update
# apt-get install pdns-server
</code></pre>

<p><strong><em>其他的系统可以到 <a href="https://repo.powerdns.com/">https://repo.powerdns.com/</a> 参考响应的安装指引</em></strong></p>

<h3 id="安装数据库">安装数据库</h3>

<ul>
<li>安装postgresql</li>
</ul>

<pre><code># apt install postgresql postgresql-client
</code></pre>

<ul>
<li>初始化数据库账号</li>
</ul>

<pre><code># sudo -u postgres psql
postgres=# create user pdns with password 'mypdnspassword';
postgres=# create database pdns owner pdns;
postgres=# grant all privileges on database pdns to pdns;
postgres=# \q
</code></pre>

<ul>
<li>安装powerdns的backend</li>
</ul>

<pre><code># apt install pdns-backend-pgsql
</code></pre>

<p>安装过程中会询问数据库用户的信息，根据前面初始化的用户名/密码，填入即可</p>

<ul>
<li>建立主从数据的复制</li>
</ul>

<p>在从服务器上执行</p>

<pre><code># psql -U pdns -d pdns -h 127.0.0.1 -p 5432

pdns=&gt; insert into supermasters (ip, nameserver, account) values ('x.x.x.x1', 'ns2.some.host','admin');

pdns=&gt;\q

# systemctl restart pdns
</code></pre>

<p>x.x.x.x1 是主服务器的IP地址</p>

<h3 id="安装-poweradmin">安装 <a href="http://www.poweradmin.org/" title="poweradmin">poweradmin</a></h3>

<p><strong>管理界面只安装在主服务器上</strong></p>

<ul>
<li>安装基础设施</li>
</ul>

<pre><code># apt install php mcrypt php-mcrypt php-pgsql
# systemctl start php7.0-fpm
# systemctl enable php7.0-fpm
# apt install nginx
</code></pre>

<ul>
<li>配置PHP环境</li>
</ul>

<pre><code># vim /etc/nginx/sites-available/pdns

server {
    server_name pdns.some.local ;
    listen 80;
    root /var/www/html/pdns;

    access_log /var/log/nginx/pdns-access.log;
    error_log /var/log/nginx/pdns-error.log;

    index index.php;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~ \.php$ {
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass unix:/var/run/php/php7.0-fpm.sock;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_intercept_errors off;
        fastcgi_buffer_size 16k;
        fastcgi_buffers 4 16k;
    }

    location ~ /\.ht {
        deny all;
    }
}

# ln -s /etc/nginx/sites-available/pdns /etc/nginx/sites-enabled/pdns
# nginx -t
# systemctl restart nginx
</code></pre>

<ul>
<li>使用Git安装软件</li>
</ul>

<pre><code># git clone https://github.com/poweradmin/poweradmin.git /var/www/html/pdns/
# chown -R www-data: /var/www/html/pdns/
# sudo service nginx reload
</code></pre>

<ul>
<li>打开网页，进入安装向导</li>
</ul>

<pre><code>* Username: pdns
* Password: &lt;mypdnspassword&gt; 
* Database type: PostgreSQL
* Hostname: 127.0.0.1
* DB Port: 5432
* Database: pdns
* Poweradmin administrator password: &lt;newpasswordforwebuser&gt;
</code></pre>

<ul>
<li>编辑应用程序配置文件</li>
</ul>

<pre><code># mv /var/www/html/pdns/inc/config-me.inc.php /var/www/html/pdns/inc/config.inc.php
# chown www-data: /var/www/html/pdns/config.inc.php
# vim /var/www/html/pdns/config.inc.php
$db_host = 'localhost';
$db_port = '5432';
$db_user = 'pdns';
$db_pass = '&lt;mypdnspassword&gt;';
$db_name = 'pdns';
$db_type = 'pgsql';
</code></pre>

<ul>
<li>删除安装向导</li>
</ul>

<pre><code># rm -rf /var/www/html/pdns/install/
</code></pre>

<h2 id="配置服务">配置服务</h2>

<h3 id="配置主机环境">配置主机环境</h3>

<ul>
<li><p>配置主机host文件，强制解析 ns1, ns2</p>

<pre><code># vim /etc/hosts
x.x.x.x1   ns1.some.host
x.x.x.x2   ns2.some.host
</code></pre>

<p>两台解析服务器都使用相同配置</p></li>

<li><p>分别在两台主机验证</p></li>
</ul>

<pre><code># ping ns1.some.host
# ping ns2.some.host
</code></pre>

<ul>
<li>配置<a href="https://powerdns.com/" title="powerdns">powerdns</a>配置文件</li>
</ul>

<p>在主服务器(ns1.some.host)上配置</p>

<pre><code># vim /etc/powerdns/pdns.conf

config-dir=/etc/powerdns
setuid=pdns
setgid=pdns
master=yes
slave=no
allow-axfr-ips=x.x.x.x2/32
default-soa-name=ns1.some.host
dnsupdate=yes
daemon=yes
disable-axfr=no
guardian=yes
local-address=0.0.0.0
local-port=53
log-dns-details=no
log-dns-queries=no
loglevel=9
socket-dir=/var/run
version-string=powerdns
include-dir=/etc/powerdns/pdns.d
launch=
</code></pre>

<p>其中x.x.x.x2为从服务器ns2.some.host的ip地址</p>

<p>在从服务器(ns2.some.host)上配置</p>

<pre><code># vim /etc/powerdns/pdns.conf

config-dir=/etc/powerdns
setuid=pdns
setgid=pdns
master=no
slave=yes
daemon=yes
disable-axfr=yes
guardian=yes
local-address=0.0.0.0
local-port=53
log-dns-details=no
log-dns-queries=no
loglevel=9
slave-cycle-interval=60
socket-dir=/var/run
version-string=powerdns
include-dir=/etc/powerdns/pdns.d
launch=
</code></pre>

<h3 id="使用-poweradmin-界面创建-master-zone">使用<a href="http://www.poweradmin.org/" title="poweradmin">poweradmin</a>界面创建 master zone</h3>

<p>登录到<a href="http://www.poweradmin.org/" title="poweradmin">poweradmin</a>的网页， 选择Add master zone的菜单，进入新建向导的网页, 在zone里输入域名 some.host</p>

<p>点击，list zone, 选择刚才创建的some.host, 这里系统会创建SOA记录，如：</p>

<pre><code>some.host	SOA	ns1.some.host hostmaster.some.host 2017101100 28800 7200 604800 86400
</code></pre>

<p>第一条ns1.some.host为主服务器域名</p>

<p>第二条hostmaster.some.host实际上是邮件地址，系统替换第一个&rsquo;.&lsquo;为&rsquo;@&lsquo;, 这里代表的地址是hostmaster@some.host，具体可以根据实际情况写自己的邮箱地址</p>

<p>创建成功以后可以用dig命令核实一下</p>

<pre><code>dig some.host soa @localhost
;; ANSWER SECTION:
some.host.              3600    IN      SOA     ns1.some.host. hostmaster.some.host. 2017101106 28800 7200 604800 86400
</code></pre>

<h3 id="创建dnssec记录">创建DNSSEC记录</h3>

<ul>
<li>使用pdnsutil创建DNSSEC</li>
</ul>

<pre><code>pdnsutil secure-zone some.host

Securing zone with default key size
Adding CSK (257) with algorithm ecdsa256
Zone some.host secured
gpgsql Connection successful. Connected to database 'pdns' on 'localhost'.
Adding NSEC ordering information
</code></pre>

<ul>
<li>查看已经生成的key</li>
</ul>

<pre><code>pdnsutil show-zone some.host

This is a Master zone
Last SOA serial number we notified: 2017101100 == 2017101100 (serial in the database)
Metadata items: None
Zone has NSEC semantics
keys:
ID = 10 (CSK), flags = 257, tag = 59581, algo = 13, bits = 256    Active ( ECDSAP256SHA256 )
CSK DNSKEY = some.host. IN DNSKEY 257 3 13 PQ29wza3majnpUQ+21oEkQjfpyN3dMnTy0StcnNX7YeuRRkOeddqPpFMDoeovZcpQGV0BxduvFn/Q2DW5WXp8w== ; ( ECDSAP256SHA256 )
DS = some.host. IN DS 59581 13 1 7908b7585027f7a262d664c7ee07ae5c5733d44e ; ( SHA1 digest )
DS = some.host. IN DS 59581 13 2 cfc9006e02d2a02448cd8cdde7fcb8e840703883b166685f37db5225ad902a88 ; ( SHA256 digest )
DS = some.host. IN DS 59581 13 3 67099daf0ecaf3e99c1c5dcce132c66dc201d27d2f1baade0fecbbbaa2c6b423 ; ( GOST R 34.11-94 digest )
DS = some.host. IN DS 59581 13 4 53062fef193fae2564f9f2441cb821ae3b55c92afac5790ae70cb8e9359313e0a4c879a09c44c9cb98ed68100cf2e938 ; ( SHA-384 digest )
</code></pre>

<ul>
<li>把相关信息推送到从服务器</li>
</ul>

<p>在主服务器上执行</p>

<pre><code># pdnsutil rectify-zone some.host
</code></pre>

<h2 id="注册解析服务">注册解析服务</h2>

<ul>
<li>注册nameserver的IP地址</li>
</ul>

<p>打开域名注册商的网页，我这里以<a href="https://www.namesilo.com" title="namesilo">namesilo</a>为例</p>

<p>点击domain manager, 再点击已经注册成功的域名(some.host)，进入域名管理界面</p>

<p>在NameServers部分，点击View/Manage Registered NameServers， 进入注册域名解析服务器页面</p>

<p>点击 REGISTER NEW NAMESERVER 按钮，分别加入ns1, ns2的IP地址</p>

<ul>
<li>注册DNSSEC</li>
</ul>

<p>回到之前域名管理的页面， 点击DS Records (DNSSEC):后面的Update连接</p>

<p>进入注册Key的界面， 相关信息在之前 pdnsutil show-zone some.host 的部分已经列出</p>

<pre><code>DS = some.host. IN DS 59581 13 1 7908b7585027f7a262d664c7ee07ae5c5733d44e ; ( SHA1 digest )
</code></pre>

<p>Digest = 7908b7585027f7a262d664c7ee07ae5c5733d44e</p>

<p>Key Tag = 59581</p>

<p>Digest Type = 1</p>

<p>Algorithm = 13</p>

<h2 id="检验">检验</h2>

<ul>
<li>检查域名是否已在全球生效</li>
</ul>

<p>打开网站： <a href="https://dnschecker.org/">https://dnschecker.org/</a></p>

<p>输入域名 some.host , 检查各地的解析情况</p>

<ul>
<li>使用dig在本地服务器检验DNSSEC</li>
</ul>

<pre><code># dig some.host +dnssec +multi @localhost

;; AUTHORITY SECTION:
some.host.              86400 IN SOA ns1.some.host. hostmaster.some.host. (
                                2017101100 ; serial
                                28800      ; refresh (8 hours)
                                7200       ; retry (2 hours)
                                604800     ; expire (1 week)
                                86400      ; minimum (1 day)
                                )
some.host.              86400 IN RRSIG SOA 13 2 86400 (
                                20171019000000 20170928000000 59581 some.host.
                                UyrOyITKMWhtf2n8lN3ZhtxaAGSMFQI9Qndd49D2/Pe5
                                wWLileK3RVPFRGlXflQfFDfQ6wb7R5+aBCls6qkmIA== )
some.host.              86400 IN NSEC some.host. SOA RRSIG NSEC DNSKEY
some.host.              86400 IN RRSIG NSEC 13 2 86400 (
                                20171019000000 20170928000000 59581 some.host.
                                4fjlTftqvjmoH0OwVf3uuC8OvvuYyyIckn+c5L0J89Np
                                kc1+LCZ5DJpQrnbsWypxr5bDXARB86pr046dbrs21A== )
</code></pre>

<ul>
<li>使用在线工具检验 DNSSEC</li>
</ul>

<p>打开网页 <a href="https://dnssec-debugger.verisignlabs.com">https://dnssec-debugger.verisignlabs.com</a></p>

<p>输入域名 some.host</p>

<h2 id="参考资料">参考资料</h2>

<ul>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-install-and-configure-powerdns-with-a-mariadb-backend-on-ubuntu-14-04">How To Install and Configure PowerDNS with a MariaDB Backend on Ubuntu 14.04</a></li>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-configure-dns-replication-on-a-slave-powerdns-server-on-ubuntu-14-04">How To Configure DNS Replication on a Slave PowerDNS Server on Ubuntu 14.04</a></li>
<li><a href="http://mindwatering.com/SupportRef.nsf/webpg/9F706A2177A497FE8525812D00041654">PowerDNS and PowerAdmin Set-up w/ Ubuntu 16.04</a></li>
<li>官方安装文档 <a href="https://doc.powerdns.com/authoritative/installation.html">https://doc.powerdns.com/authoritative/installation.html</a></li>
</ul>

<h2 id="vps-推荐">VPS 推荐</h2>

<ul>
<li><a href="https://www.linode.com/?r=ec0967c3fb5243693ca573d68000d3a63442ac66">linode 东京</a></li>
<li><a href="https://bandwagonhost.com/aff.php?aff=20451">bandwagonhost 中国优化</a></li>
<li><a href="https://www.dgchost.net/client/aff.php?aff=226">dgchost 新加波</a></li>
</ul>

      
      
      
    </article>
    
 <aside><div id="disqus_thread"></div></aside>

<script type="text/javascript">
     
    var disqus_shortname = 'windyboy';

     
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>



  </main>
  
  <nav class="pagination-single">
    
      <span class="previous">&larr; <a href="https://windyboy.github.io/post/2016/09/tomcat-keystore-using-letsencrypt-certs/" rel="prev">tomcat 以 keystore 的方式使用 letsencrypt 证书</a></span>
    
    
  </nav>


  
  <footer role="contentinfo">
    <div style="text-align:center;">
      <img src="/images/profile.png" width="64" height="64"><br>
      Written by windyboy
    </div>
  </footer>


</div>

<script src="/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-78513355-1', 'auto');
	ga('send', 'pageview');
</script>

</body>
</html>

